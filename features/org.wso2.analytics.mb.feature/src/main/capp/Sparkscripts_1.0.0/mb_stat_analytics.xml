<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>mb_stat_analytics</Name>
    <Script>
        CREATE TEMPORARY TABLE mbTimerStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_timer_stats_minute",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, minute INT -i, source FACET -i, name FACET -i,
        type FACET -i, destination FACET -i, maxDuration DOUBLE, meanDuration DOUBLE, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, minute, name, type, destination, source",
        incrementalProcessing "mbTimerStatPerMinute, HOUR",
        mergeSchema "false",
        globalTenantAccess "true");

        CREATE TEMPORARY TABLE mbMeterStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_meter_stats_minute",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, minute INT -i, source FACET -i, name FACET -i,
        type FACET -i, destination FACET -i, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, minute, name, type, destination, source",
        incrementalProcessing "mbMeterStatPerMinute, HOUR",
        mergeSchema "false",
        globalTenantAccess "true");

        CREATE TEMPORARY TABLE mbGaugeStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_gauge_stats_minute",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, minute INT -i, source FACET -i, name FACET -i,
        type FACET -i, destination FACET -i, value DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, minute, name, type, destination, source",
        incrementalProcessing "mbGaugeStatPerMinute, HOUR",
        mergeSchema "false",
        globalTenantAccess "true");

        CREATE TEMPORARY TABLE mbCounterStatPerMinute USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_counter_stats_minute",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, minute INT -i, source FACET -i, name FACET -i,
        type FACET -i, destination FACET -i, totalCount LONG, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, minute, name, type, destination, source",
        incrementalProcessing "mbCounterStatPerMinute, HOUR",
        mergeSchema "false",
        globalTenantAccess "true");

        CREATE TEMPORARY TABLE mbTimerStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_timer_stats_hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, maxDuration DOUBLE, meanDuration DOUBLE, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, name, type, destination, source",
        incrementalProcessing "mbTimerStatPerHour, DAY",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbTimerStatPerHour
        SELECT year, month, day, hour, source, name, type, destination, MAX(maxDuration) as maxDuration,
        AVG(meanDuration) as meanDuration, AVG(rate) as rate, _tenantId,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM mbTimerStatPerMinute
        GROUP BY
        year, month, day, hour, name, type, destination, source, _tenantId;

        INCREMENTAL_TABLE_COMMIT mbTimerStatPerMinute;

        CREATE TEMPORARY TABLE mbMeterStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_meter_stats_hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, name, type, destination, source",
        incrementalProcessing "mbMeterStatPerHour, DAY",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbMeterStatPerHour
        SELECT year, month, day, hour, source, name, type, destination, AVG(rate) as rate, _tenantId,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM mbMeterStatPerMinute
        GROUP BY
        year, month, day, hour, name, type, destination, source, _tenantId;

        INCREMENTAL_TABLE_COMMIT mbMeterStatPerMinute;

        CREATE TEMPORARY TABLE mbGaugeStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_gauge_stats_hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, value DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, name, type, destination, source",
        incrementalProcessing "mbGaugeStatPerHour, DAY",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbGaugeStatPerHour
        SELECT year, month, day, hour, source, name, type, destination, AVG(value) as value, _tenantId,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM mbGaugeStatPerMinute
        GROUP BY
        year, month, day, hour, name, type, destination, source, _tenantId;

        INCREMENTAL_TABLE_COMMIT mbGaugeStatPerMinute;

        CREATE TEMPORARY TABLE mbCounterStatPerHour USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_counter_stats_hour",
        schema "year INT -i, month INT -i, day INT -i, hour INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, totalCount LONG, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, hour, name, type, destination, source",
        incrementalProcessing "mbCounterStatPerHour, DAY",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbCounterStatPerHour
        SELECT year, month, day, hour, source, name, type, destination, MAX(totalCount), _tenantId,
        getHourStartingTime(year, month, day, hour) as _timestamp
        FROM mbCounterStatPerMinute
        GROUP BY
        year, month, day, hour, name, type, destination, source, _tenantId;

        INCREMENTAL_TABLE_COMMIT mbCounterStatPerMinute;

        CREATE TEMPORARY TABLE mbTimerStatPerDay USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_timer_stats_day",
        schema "year INT -i, month INT -i, day INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, maxDuration DOUBLE, meanDuration DOUBLE, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbTimerStatPerDay
        SELECT year, month, day, source, name, type, destination, MAX(maxDuration) as maxDuration,
        AVG(meanDuration) as meanDuration, AVG(rate) as rate, _tenantId,
        getDateStartingTime(year, month, day) as _timestamp
        FROM mbTimerStatPerHour
        GROUP BY
        year, month, day, name, type, destination, source, _tenantId;

        INCREMENTAL_TABLE_COMMIT mbTimerStatPerHour;

        CREATE TEMPORARY TABLE mbMeterStatPerDay USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_meter_stats_day",
        schema "year INT -i, month INT -i, day INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbMeterStatPerDay
        SELECT year, month, day, source, name, type, destination, AVG(rate) as rate, _tenantId,
        getDateStartingTime(year, month, day) as _timestamp
        FROM mbMeterStatPerHour
        GROUP BY
        year, month, day, name, type, destination, source, _tenantId;

        INCREMENTAL_TABLE_COMMIT mbMeterStatPerHour;

        CREATE TEMPORARY TABLE mbGaugeStatPerDay USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_gauge_stats_day",
        schema "year INT -i, month INT -i, day INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, value DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbGaugeStatPerDay
        SELECT year, month, day, source, name, type, destination, AVG(value) as value, _tenantId,
        getDateStartingTime(year, month, day) as _timestamp
        FROM mbGaugeStatPerHour
        GROUP BY
        year, month, day, name, type, destination, source, _tenantId;

        CREATE TEMPORARY TABLE mbCounterStatPerDay USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_counter_stats_day",
        schema "year INT -i, month INT -i, day INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, totalCount LONG, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, day, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbCounterStatPerDay
        SELECT year, month, day, source, name, type, destination, MAX(totalCount), _tenantId,
        getDateStartingTime(year, month, day) as _timestamp
        FROM mbCounterStatPerHour
        GROUP BY
        year, month, day, name, type, destination, source, _tenantId;

        INCREMENTAL_TABLE_COMMIT mbCounterStatPerHour;

        CREATE TEMPORARY TABLE mbTimerStatPerMonth USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_timer_stats_month",
        schema "year INT -i, month INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, maxDuration DOUBLE, meanDuration DOUBLE, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbTimerStatPerMonth
        SELECT year, month, source, name, type, destination, MAX(maxDuration) as maxDuration,
        AVG(meanDuration) as meanDuration, AVG(rate) as rate, _tenantId,
        getMonthStartingTime(year, month) as _timestamp
        FROM mbTimerStatPerDay
        GROUP BY
        year, month, name, type, destination, source, _tenantId;

        CREATE TEMPORARY TABLE mbMeterStatPerMonth USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_meter_stats_month",
        schema "year INT -i, month INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, rate DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbMeterStatPerMonth
        SELECT year, month, source, name, type, destination, AVG(rate) as rate, _tenantId,
        getMonthStartingTime(year, month) as _timestamp
        FROM mbMeterStatPerDay
        GROUP BY
        year, month, name, type, destination, source, _tenantId;

        CREATE TEMPORARY TABLE mbGaugeStatPerMonth USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_gauge_stats_month",
        schema "year INT -i, month INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, value DOUBLE, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbGaugeStatPerMonth
        SELECT year, month, source, name, type, destination, AVG(value) as value, _tenantId,
        getMonthStartingTime(year, month) as _timestamp
        FROM mbGaugeStatPerDay
        GROUP BY
        year, month, name, type, destination, source, _tenantId;

        CREATE TEMPORARY TABLE mbCounterStatPerMonth USING CarbonAnalytics
        OPTIONS (tableName "org_wso2_mb_counter_stats_month",
        schema "year INT -i, month INT -i, source FACET -i, name FACET -i, type FACET -i,
        destination FACET -i, totalCount LONG, _tenantId INT, _timestamp LONG -i",
        primaryKeys "year, month, name, type, destination, source",
        mergeSchema "false",
        globalTenantAccess "true");

        INSERT INTO TABLE mbCounterStatPerMonth
        SELECT year, month, source, name, type, destination, MAX(totalCount), _tenantId,
        getMonthStartingTime(year, month) as _timestamp
        FROM mbCounterStatPerDay
        GROUP BY
        year, month, name, type, destination, source, _tenantId;
    </Script>
    <CronExpression>0 0/2 * * * ? *</CronExpression>
</Analytics>
